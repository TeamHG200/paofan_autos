## æ³¡é¥­æœºå™¨äººè®¡åˆ’

> æ³¡é¥­æœºå™¨äººæ˜¯ç”±ç”¨æˆ·è‡ªä¸»å¼€å‘çš„ä¸€äº›åˆ—åŠŸèƒ½è„šæœ¬ï¼Œå…¶å¯ä»¥é€šè¿‡IOSæ³¡é¥­å®¢æˆ·ç«¯ä¾›å…¶ä»–ç”¨æˆ·ä½¿ç”¨ï¼Œ ç”¨æˆ·å¯ä»¥é€šè¿‡PaoFanæ¥è¿œç¨‹æ‰“å¼€ï¼Œå…³é—­å’Œè®¾ç½®ã€‚

> æ³¡é¥­ä½œè€…å¯¹é¥­å¦APIåšäº†ç²¾ç®€æŠ½è±¡ï¼Œæä¾›äº†ç²¾ç®€çš„è„šæœ¬å®ç°ï¼Œåªéœ€è¦ç®€å•å‡ è¡Œä»£ç å³å¯å®Œæˆç¨€å¥‡å¤æ€ªçš„ç”¨æˆ·ï¼Œä»»ä½•äººéƒ½å¯ä»¥è½»æ¾ä¸Šæ‰‹ã€‚

> æœåŠ¡å™¨ä¼šæŠŠç”¨æˆ·è®¾è®¡çš„æœºå™¨äººå…±äº«ç»™å…¨éƒ¨ç”¨æˆ·ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨å®ƒæ¥æ­¦è£…è‡ªå·±çš„è´¦å·ï¼Œæ¯”å¦‚æŠŠè‡ªå·±å˜æˆä¸€ä¸ªå¤§ç¬¨é’Ÿå®šæ—¶éªšæ‰°åˆ«äººâ°ï¼Œåˆæˆ–è€…è‡ªåŠ¨å›å¤æ¯ä¸€å¥æ™šå®‰çš„å°é²¸é±¼ğŸ³ã€‚

> æ€»ä¹‹æ²¡æ—¶é—´è§£é‡Šäº†ï¼Œå¿«å¿«ä¸Šè½¦å§ï¼


### APIç®€ä»‹

| æ–¹æ³•å | å‚æ•° | è¿”å› | å«ä¹‰ |
| ----- | ---- | --- | --- |
| ff:post | table | æ—  | å‘é€é¥­å¦æ¶ˆæ¯ |
| ff:timeline | table | table | è·å–æŒ‡å®šè´¦å·çš„æ—¶é—´çº¿ | 
| db:apns | table | æ—  | ç»™æŒ‡å®šè´¦å·å‘é€ä¸€æ¡æ¨é€ | 

#### ç¤ºä¾‹

* å¤§ç¬¨é’Ÿ: æ•´ç‚¹å‘é€ä¸€æ¡"guang! guang!" çš„æ¶ˆæ¯

~~~
-- è·å–æ ¼æ—å°¼æ²»æ—¶é—´çš„å°æ—¶ç„¶ååŠ ä¸Šæ—¶åŒº +8
local time = tonumber(string.format("%d",os.time()/3600%24+8))

-- è·å–ä¸Šæ¬¡å’£çš„æ¬¡æ•°ï¼Œå¦‚æœä¸Šæ¬¡æ²¡æœ‰å’£è¿‡ï¼Œé‚£å°±æ˜¯0
local count = tonumber(args["local_time"]) or 0

-- å¦‚æœå½“å‰æ—¶é—´å¤§äºä¸Šæ¬¡å’£çš„æ—¶é—´ï¼Œé‚£å°±è¦å¼€å§‹å’£äº†
if time > count then

    -- ç”Ÿæˆå’£çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœå½“å‰æ—¶é—´æ˜¯8ç‚¹ï¼Œå°±è¦å’£8æ¬¡
    local str = ""
    for i=1,time do str = str.." guang!" end

    -- å‘é€é¥­å¦ï¼Œå½“å‰è´¦å·
    ff:post({ status = str })

    -- ä¿å­˜è¿™æ¬¡å’£çš„æ¬¡æ•°ï¼Œä¸‹æ¬¡å‚ä¸è®¡ç®—ï¼Œé¿å…é‡å¤å’£
    args["local_time"] =  tostring(time)

end
~~~


* ç‹—è›‹: å…³æ³¨ç”¨æˆ·å¦‚æœå‘æ¶ˆæ¯äº†ï¼Œåˆ™æé†’è‡ªå·±

~~~
-- ä»ä¸Šä¸€æ¬¡çš„æ¶ˆæ¯å¼€å§‹ï¼Œè·å–ç”¨æˆ·çš„æ–°æ¶ˆæ¯
local t = ff:timeline({
        user_id = args["target_user"],  -- å…³æ³¨ç”¨æˆ·çš„id
        since_id = args["since_id"]     -- å…³æ³¨ç”¨æˆ·ä¸Šæ¬¡çš„æœ€æ–°æ¶ˆæ¯
        })

-- æŠŠJSONæ¶ˆæ¯è½¬åŒ–ä¸ºTABLEç»“æ„
local tl = json.decode(t)

-- å¦‚æœç”¨æˆ·æœ‰æ–°æ¶ˆæ¯ï¼Œåˆ™è¿”å›ç»“æœå¤§äº0
if #tl > 0 then

    -- ç»™è‡ªå·±å‘é€ä¸€ä¸ªæ¨é€é€šçŸ¥
    db:apns({
            user_id = args["user_id"],
            content = "ç‹—è›‹è¹­äº†è¹­ä½ ï¼Œå¹¶å¯¹ä½ è¯´æœ‰æ–°æ¶ˆæ¯å•¦ï¼"
            })

    -- åŒæ—¶è®°å½•ä¸‹å…³æ³¨çš„ç”¨æˆ·æœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯id
    args["since_id"] = tl[1]["id"]
end

~~~

* å°å°é²¸é±¼: å¯¹è‡ªå·±æ—¶é—´çº¿ä¸Šè¯´"æ™šå®‰"çš„äººå›å¤"æ™šå®‰"

~~~
-- ä»ä¸Šä¸€æ¬¡çš„æ¶ˆæ¯å¼€å§‹ï¼Œè·å–å½“å‰æ‰€æœ‰çš„æ–°æ¶ˆæ¯
local t = ff:home({
          since_id = args["since_id"]
          })

-- æŠŠJSONæ¶ˆæ¯è½¬åŒ–ä¸ºTABLEç»“æ„
local tl = json.decode(t)

-- å¦‚æœç”¨æˆ·æœ‰æ–°æ¶ˆæ¯ï¼Œåˆ™è¿”å›ç»“æœå¤§äº0
if #tl > 0 then

    -- ç»™æ¯ä¸€ä¸ªè¯´æ™šå®‰çš„äººå›å¤æ™šå®‰
    for i=1,#tl do
        local status = tl[1]
        if status["text"] == "æ™šå®‰" then
            ff:post({
                status = "@"..status["user"]["name"].." æ™šå®‰",
                reply_id = status["id"]
            })
        end
    end

    -- åŒæ—¶è®°å½•ä¸‹å…³æ³¨çš„ç”¨æˆ·æœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯id
    args["since_id"] = tl[1]["id"]
end
~~~
